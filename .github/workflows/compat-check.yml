#----------------------------------------------------------------------------------------------------
# Copyright (c) 2025                    orgrinrt                    orgrinrt@ikiuni.dev
# SPDX-License-Identifier: MPL-2.0      https://mozilla.org/MPL/2.0 contact@hiisi.digital
#----------------------------------------------------------------------------------------------------

name: Runtime Compatibility Matrix

on:
  push:
    branches: [main]
  pull_request:
  workflow_dispatch:

# Cancel in-progress runs for the same branch
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # ============================================================================
  # Build packages for testing
  # ============================================================================
  build:
    name: Build packages
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Deno
        uses: denoland/setup-deno@v2
        with:
          deno-version: v2.x

      - name: Build npm package (production)
        run: deno run -A scripts/build-npm.ts

      - name: Build npm package with tests
        run: deno run -A scripts/build-npm-with-tests.ts --skip-test

      - name: Upload npm artifact
        uses: actions/upload-artifact@v4
        with:
          name: npm-package
          path: npm/
          retention-days: 1

      - name: Upload npm-test artifact
        uses: actions/upload-artifact@v4
        with:
          name: npm-test-package
          path: npm-test/
          retention-days: 1

  # ============================================================================
  # Test Deno versions (runs against source)
  # ============================================================================
  test-deno:
    name: Deno ${{ matrix.deno-version }}
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        deno-version: ["v1.x", "v2.x"]

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Deno ${{ matrix.deno-version }}
        uses: denoland/setup-deno@v2
        with:
          deno-version: ${{ matrix.deno-version }}

      - name: Show Deno version
        id: version
        run: |
          VERSION=$(deno --version | head -n1 | awk '{print $2}')
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Deno version: $VERSION"

      - name: Smoke test
        id: smoke
        continue-on-error: true
        run: deno run --allow-read tests/deno/smoke.test.ts

      - name: Type check
        id: types
        continue-on-error: true
        run: |
          deno check tests/deno/types.test.ts
          deno run --allow-read tests/deno/types.test.ts

      - name: Full test suite (unit + integration)
        id: tests
        continue-on-error: true
        run: |
          deno test --allow-read --allow-write --allow-env --allow-run \
            tests/_utils/ \
            tests/config_test.ts \
            tests/contributors_test.ts \
            tests/formatter_test.ts \
            tests/glob_test.ts \
            tests/header_test.ts \
            tests/integration_test.ts

      - name: Write result
        run: |
          mkdir -p results
          cat > results/deno-${{ matrix.deno-version }}.json << JSONEOF
          {
            "runtime": "deno",
            "version": "${{ matrix.deno-version }}",
            "actualVersion": "${{ steps.version.outputs.version }}",
            "smoke": "${{ steps.smoke.outcome }}",
            "types": "${{ steps.types.outcome }}",
            "tests": "${{ steps.tests.outcome }}"
          }
          JSONEOF
          cat results/deno-${{ matrix.deno-version }}.json

      - name: Upload result
        uses: actions/upload-artifact@v4
        with:
          name: result-deno-${{ matrix.deno-version }}
          path: results/
          retention-days: 1

  # ============================================================================
  # Test Node.js versions (runs against built package)
  # ============================================================================
  test-node:
    name: Node.js ${{ matrix.node-version }}
    runs-on: ubuntu-latest
    needs: build
    strategy:
      fail-fast: false
      matrix:
        node-version: ["18", "20", "22"]

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download npm artifact
        uses: actions/download-artifact@v4
        with:
          name: npm-package
          path: npm/

      - name: Download npm-test artifact
        uses: actions/download-artifact@v4
        with:
          name: npm-test-package
          path: npm-test/

      - name: Setup Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}

      - name: Show Node version
        id: version
        run: |
          VERSION=$(node --version)
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Node.js version: $VERSION"

      - name: Smoke test
        id: smoke
        continue-on-error: true
        run: node tests/node/smoke.test.mjs

      - name: Install TypeScript dependencies
        run: |
          npm init -y
          npm pkg set type="module"
          npm install typescript tsx

      - name: Type check
        id: types
        continue-on-error: true
        run: npx tsx tests/node/types.test.ts

      - name: Install test package dependencies
        working-directory: npm-test
        run: npm install

      - name: Full test suite (unit + integration)
        id: tests
        continue-on-error: true
        working-directory: npm-test
        run: |
          echo "Running test suite on Node.js ${{ matrix.node-version }}..."
          # Run tests using the test runner script
          node test-runner.js

      - name: Write result
        run: |
          mkdir -p results
          cat > results/node-${{ matrix.node-version }}.json << JSONEOF
          {
            "runtime": "node",
            "version": "${{ matrix.node-version }}",
            "actualVersion": "${{ steps.version.outputs.version }}",
            "smoke": "${{ steps.smoke.outcome }}",
            "types": "${{ steps.types.outcome }}",
            "tests": "${{ steps.tests.outcome }}"
          }
          JSONEOF
          cat results/node-${{ matrix.node-version }}.json

      - name: Upload result
        uses: actions/upload-artifact@v4
        with:
          name: result-node-${{ matrix.node-version }}
          path: results/
          retention-days: 1

  # ============================================================================
  # Test Bun versions (runs against built package)
  # ============================================================================
  test-bun:
    name: Bun ${{ matrix.bun-version }}
    runs-on: ubuntu-latest
    needs: build
    strategy:
      fail-fast: false
      matrix:
        bun-version: ["1.0.0", "1.1.0", "latest"]

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download npm artifact
        uses: actions/download-artifact@v4
        with:
          name: npm-package
          path: npm/

      - name: Download npm-test artifact
        uses: actions/download-artifact@v4
        with:
          name: npm-test-package
          path: npm-test/

      - name: Setup Bun ${{ matrix.bun-version }}
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: ${{ matrix.bun-version }}

      - name: Show Bun version
        id: version
        run: |
          VERSION=$(bun --version)
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Bun version: $VERSION"

      - name: Smoke test
        id: smoke
        continue-on-error: true
        run: bun run tests/node/smoke.test.mjs

      - name: Type check
        id: types
        continue-on-error: true
        run: bun run tests/node/types.test.ts

      - name: Install test package dependencies
        working-directory: npm-test
        run: bun install

      - name: Full test suite (unit + integration)
        id: tests
        continue-on-error: true
        working-directory: npm-test
        run: |
          echo "Running test suite on Bun ${{ matrix.bun-version }}..."
          # Run tests using the Bun test runner script
          bun bun-test-runner.js

      - name: Write result
        run: |
          mkdir -p results
          SAFE_VERSION=$(echo "${{ matrix.bun-version }}" | tr '.' '_')
          cat > results/bun-${SAFE_VERSION}.json << JSONEOF
          {
            "runtime": "bun",
            "version": "${{ matrix.bun-version }}",
            "actualVersion": "${{ steps.version.outputs.version }}",
            "smoke": "${{ steps.smoke.outcome }}",
            "types": "${{ steps.types.outcome }}",
            "tests": "${{ steps.tests.outcome }}"
          }
          JSONEOF
          cat results/bun-${SAFE_VERSION}.json

      - name: Upload result
        uses: actions/upload-artifact@v4
        with:
          name: result-bun-${{ matrix.bun-version }}
          path: results/
          retention-days: 1

  # ============================================================================
  # Collect results and generate compatibility matrix
  # ============================================================================
  report:
    name: Generate Compatibility Report
    runs-on: ubuntu-latest
    if: always()
    needs: [test-deno, test-node, test-bun]
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download all results
        uses: actions/download-artifact@v4
        with:
          pattern: result-*
          path: all-results/
          merge-multiple: false

      - name: List downloaded results
        run: |
          echo "Downloaded results:"
          find all-results -name "*.json" -type f | sort | while read f; do
            echo "=== $f ==="
            cat "$f"
          done

      - name: Generate COMPATIBILITY.md
        run: |
          chmod +x scripts/generate-compat-report.sh
          ./scripts/generate-compat-report.sh \
            "all-results" \
            "${{ github.run_number }}" \
            "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"

      - name: Update README.md with compatibility section
        run: |
          chmod +x scripts/update-readme-compat.sh
          ./scripts/update-readme-compat.sh "all-results"

      - name: Commit and push changes
        if: github.event_name != 'pull_request'
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

          git add COMPATIBILITY.md README.md

          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "docs: update runtime compatibility matrix [skip ci]"
            git push
          fi

      - name: Upload final report
        uses: actions/upload-artifact@v4
        with:
          name: compatibility-report
          path: |
            COMPATIBILITY.md
            all-results/
          retention-days: 30
