#!/bin/sh
#----------------------------------------------------------------------------------------------------
# ante - Copyright header management - Pre-commit hook
# Auto-generated by ante. Do not edit manually.
#----------------------------------------------------------------------------------------------------
#
# This hook:
# 1. Checks if staged .ts files have a copyright header
# 2. If missing, creates one with the current git user
# 3. If present but current user not listed, adds them
# 4. Updates copyright year range when files change
#

# Get the directory where this hook script is located
HOOK_DIR="$(cd "$(dirname "$0")" && pwd)"

# Source the shared functions
. "${HOOK_DIR}/functions.sh"

# Get current git user info
GIT_USER_NAME=$(git config user.name || echo "")
GIT_USER_EMAIL=$(git config user.email || echo "")
CURRENT_YEAR=$(date +%Y)

# Ensure we have git user info
if [ -z "$GIT_USER_NAME" ] || [ -z "$GIT_USER_EMAIL" ]; then
    echo "Warning: Git user.name or user.email not configured."
    echo "Skipping copyright header management."
    exit 0
fi

# Track if any files were modified
FILES_MODIFIED=0

# Get list of staged TypeScript files
STAGED_TS_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep '\.ts$' || true)

if [ -z "$STAGED_TS_FILES" ]; then
    exit 0
fi

for file in $STAGED_TS_FILES; do
    # Skip if file doesn't exist
    [ ! -f "$file" ] && continue
    
    if ! has_copyright_header "$file"; then
        echo "Adding copyright header to: $file"
        create_copyright_header "$file" "$GIT_USER_NAME" "$GIT_USER_EMAIL" "$CURRENT_YEAR"
        git add "$file"
        FILES_MODIFIED=1
    else
        FIRST_YEAR=$(get_first_year "$file")
        
        if [ -n "$FIRST_YEAR" ]; then
            if ! update_year_in_header "$file" "$FIRST_YEAR" "$CURRENT_YEAR"; then
                echo "Updated copyright year in: $file"
                git add "$file"
                FILES_MODIFIED=1
            fi
        fi
        
        if ! user_in_header "$file" "$GIT_USER_EMAIL"; then
            echo "Adding contributor to: $file"
            add_contributor_to_header "$file" "$GIT_USER_NAME" "$GIT_USER_EMAIL"
            git add "$file"
            FILES_MODIFIED=1
        fi
    fi
done

if [ "$FILES_MODIFIED" -eq 1 ]; then
    echo ""
    echo "Copyright headers have been updated. Changes have been staged."
fi

exit 0
